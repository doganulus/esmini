name: Continuous Integration (Linux)

permissions:
  contents: write

on:
  push:
    paths:
      - ".github/workflows/ci-linux.yml"
      - "CMakeLists.txt"
      - "support/cmake/**"

jobs:
  build:
    name: Build esmini in container
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
    
    container:
      image: ghcr.io/bounverif/esmini:latest-builder
      env:
        ESMINI_BUILD_DOWNLOAD_DEPS: FALSE

    steps:
      - uses: actions/checkout@v4
        with:
            submodules: recursive

      - run: |
          sudo apt-get update
          sudo apt-get install ninja-build

      - name: CMake Configure
        run: |
          export CMAKE_INCLUDE_PATH=/usr/local/include/osi3
          export CMAKE_LIBRARY_PATH=/usr/local/lib/osi3
          cmake --preset=ci-ubuntu_release \
            -DUSE_OSG=1 \
            -DUSE_OSI=1 \
            -DUSE_SUMO=0 \
            -DUSE_IMPLOT=0 \
            -DUSE_GTEST=0 \
            -DESMINI_BUILD_DOWNLOAD_DEPS=FALSE

      - name: CMake Build
        run: cmake --build build --target install -j4
